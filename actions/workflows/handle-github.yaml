version: 1.0

description: Receiver for github webhooks

input:
  - trigger_data
  - trigger_headers

vars:
  # /refs/heads/master
  - branch: <% ctx().trigger_data.ref.split('/')[2] %>
  - branch_to_watch: "master"
  - event_type: <% ctx().trigger_headers["X-Github-Event"] %>
  
tasks:
  route:
    action: core.noop
    next:
      - when: <% succeeded() and ctx().branch = ctx().branch_to_watch and ctx().event_type = "push" %>
        do: handle_push


  handle_push:
    action: packs.install
    input:
      packs:
        - "<% ctx().trigger_data.repository.url %>=<% ctx().branch %>"

output:
  - branch: <% ctx().branch %>