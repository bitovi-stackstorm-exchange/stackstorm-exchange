version: 1.0

description: Receiver for github webhooks

input:
  - trigger_data
  - trigger_headers

vars:
  - branch: <% ctx().trigger_data.ref.replace(regex('\/refs\/heads\/'), '') %>
  - branch_to_watch: "master"

tasks:
  route:
    action: core.noop
    next:
      - when: <% succeeded() and ctx().branch = ctx().branch_to_watch and ctx().trigger_headers["X-Github-Event"] = "push" %>
        do: handle_push
      - when: <% succeeded %>
        publish:
          - branch: <% ctx().branch %>


  handle_push:
    action: packs.install
    input:
      packs:
        - "<% ctx().trigger_data.repository.url %>=<% ctx().branch %>"
output:
  - branch: <% ctx().branch %>