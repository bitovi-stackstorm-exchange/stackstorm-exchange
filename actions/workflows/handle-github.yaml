version: 1.0

description: Receiver for github webhooks

input:
  - trigger_data
  - trigger_headers

vars:
  - branch: <% ctx().trigger_data.ref.replace(regex('\/refs\/heads\/'), '') %>
  - branch_to_watch: "master"

tasks:
  route:
    action: core.noop
    next:
      - when: <% succeeded() and ctx().branch = ctx().branch_to_watch and ctx().trigger_headers["X-Github-Event"] = "push" and ctx().trigger_data.containsKey("commits") and ctx().trigger_data.commits.len() %>
        do: handle_master_commit


  handle_master_commit:
    action: packs.install
    input:
      packs:
        - "<% ctx().trigger_data.repository.url %>=<% ctx().branch %>"
